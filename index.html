<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CyberSec Academy — Real-World Cybersecurity</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { brand: { DEFAULT:'#00d4ff', dark:'#0c1e3e' } },
          boxShadow: { glass:'0 8px 30px rgba(2,8,23,.35)' }
        }
      }
    }
  </script>

  <!-- Icons & code highlight -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- React / Babel / Motion -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/framer-motion@11.3.31/dist/framer-motion.umd.js"></script>

  <!-- Firebase (optional real backend) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    html, body, #root { height: 100%; }
    .glass { backdrop-filter: blur(12px); background: linear-gradient(180deg, rgba(12,30,62,.65), rgba(12,30,62,.35)); }
    /* Blue/cyan hero (no purple) */
    .heroBg { background: radial-gradient(1200px 600px at 0% 20%, #0b4abf 0%, rgba(11,74,191,.25) 45%, transparent 70%),
                         radial-gradient(900px 500px at 85% 60%, rgba(0,212,255,.35) 0%, transparent 60%),
                         linear-gradient(135deg, #061a3a 0%, #0b2b66 48%, #0c1e3e 100%); }
    .code-block { border-radius: 12px; overflow: hidden; }
    @keyframes pulse-ring { 0% { transform: scale(.8); opacity:.6; } 80%,100% { transform: scale(1.8); opacity:0; } }
  </style>
</head>
<body class="bg-brand-dark text-white selection:bg-brand/40">
  <div id="root"></div>

  <script type="text/babel"
    data-presets="env,react"
    data-plugins="proposal-class-properties,proposal-object-rest-spread,proposal-optional-chaining,proposal-nullish-coalescing-operator">

/* ===== Motion fallbacks ===== */
const __FM = window['framer-motion'] || {};
const motion = __FM.motion || new Proxy({}, { get: (_, tag) => (props) => React.createElement(tag, props, props.children) });
const AnimatePresence = __FM.AnimatePresence || (({children}) => React.createElement(React.Fragment, null, children));

/* ===== Config ===== */
const CONFIG = {
  USE_FIREBASE: false,
  FIREBASE_CONFIG: {
    // Fill in to enable real auth/cloud sync:
    // apiKey: "YOUR_API_KEY",
    // authDomain: "YOUR_PROJECT.firebaseapp.com",
    // projectId: "YOUR_PROJECT",
    // storageBucket: "YOUR_PROJECT.appspot.com",
    // messagingSenderId: "SENDER_ID",
    // appId: "APP_ID"
  },
  USE_LABS: false,
  LABS_URL: "http://localhost:4000",
};

const { useState, useEffect, useMemo, useRef } = React;
const cx = (...c)=>c.filter(Boolean).join(' ');
const wait = (ms)=>new Promise(r=>setTimeout(r, ms));

/* ===== Mini Router (hash-based) + in-app history ===== */
const ROUTES = ['home','learn','maps','roles','labs','challenges','cheats','dashboard'];
function getRouteFromHash(){
  const h=(location.hash||'').replace(/^#\/?/,'');
  return ROUTES.includes(h)? h : 'home';
}
function navTo(page){ if(!ROUTES.includes(page)) page='home'; location.hash = page; }

/* ===== Firebase / local demo auth ===== */
const appState = { firebaseApp:null, auth:null, db:null, user:null };
function initFirebaseIfNeeded(){ if(!CONFIG.USE_FIREBASE) return;
  if(!CONFIG.FIREBASE_CONFIG?.apiKey) return; try{
    appState.firebaseApp=firebase.initializeApp(CONFIG.FIREBASE_CONFIG);
    appState.auth=firebase.auth(); appState.db=firebase.firestore();
  }catch(e){ console.warn('Firebase init:', e?.message); }
}
async function sha256(txt){ if(!crypto?.subtle) return txt; const enc=new TextEncoder().encode(txt);
  const h=await crypto.subtle.digest('SHA-256',enc); return [...new Uint8Array(h)].map(b=>b.toString(16).padStart(2, '0')).join(''); }
async function signUp(email, password){
  if(appState.auth){ const res=await appState.auth.createUserWithEmailAndPassword(email,password);
    return { uid:res.user.uid, email:res.user.email };
  } else {
    const hash=await sha256(password), uid=`uid_${Math.random().toString(36).slice(2,9)}`;
    const users=JSON.parse(localStorage.getItem('demoUsers')||'{}'); users[email]={hash,uid};
    localStorage.setItem('demoUsers',JSON.stringify(users)); return { uid,email };
  }
}
async function signIn(email, password){
  if(appState.auth){ const res=await appState.auth.signInWithEmailAndPassword(email,password);
    return { uid:res.user.uid, email:res.user.email };
  } else {
    const users=JSON.parse(localStorage.getItem('demoUsers')||'{}'); const u=users[email];
    if(!u) throw new Error('User not found. Please sign up.');
    const hash=await sha256(password); if(hash!==u.hash) throw new Error('Invalid credentials.');
    return { uid:u.uid, email };
  }
}
async function signOut(){ if(appState.auth) await appState.auth.signOut(); appState.user=null; }
async function saveProgress(uid,data){
  if(CONFIG.USE_FIREBASE && appState.db){
    await appState.db.collection('users').doc(uid).set({ email: (appState.user||{}).email },{merge:true});
    await appState.db.collection('users').doc(uid).collection('progress').doc('main').set(data,{merge:true});
  } else localStorage.setItem(`progress_${uid}`, JSON.stringify(data));
}
async function loadProgress(uid){
  if(CONFIG.USE_FIREBASE && appState.db){
    const d=await appState.db.collection('users').doc(uid).collection('progress').doc('main').get();
    return d.exists? d.data(): null;
  } else {
    const raw=localStorage.getItem(`progress_${uid}`); return raw? JSON.parse(raw): null;
  }
}

/* ===== Tool explainers ===== */
const TOOL_DB = {
  Wireshark:{ what:"Network protocol analyzer to capture/inspect packets.",
    steps:["Go to wireshark.org","Download for your OS","Install (Npcap on Windows)","Open, choose interface, Start."],
    link:"https://www.wireshark.org/" },
  Zeek:{ what:"Network security monitor that parses traffic into rich logs.",
    steps:["Install Zeek","Run on pcap: zeek -r file.pcap","Review conn/dns/http logs","Pivot to SIEM."],
    link:"https://zeek.org/" },
  Splunk:{ what:"SIEM for search/alerts/dashboards.",
    steps:["Install/trial Splunk","Ingest logs (UF/HEC)","Search with SPL","Make alerts/dashboards."],
    link:"https://www.splunk.com/" },
  ELK:{ what:"Elasticsearch, Logstash, Kibana.",
    steps:["Cloud or docker compose","Ship beats/logs","Kibana index pattern","Dashboards."],
    link:"https://www.elastic.co/elk-stack" },
  Nmap:{ what:"Network scanner for hosts/services.",
    steps:["Install nmap","Quick: nmap -sS subnet","Version: -sV","OS: -O"],
    link:"https://nmap.org/" },
  "Burp Suite":{ what:"Web security testing proxy.",
    steps:["Download Burp","Set browser proxy 127.0.0.1:8080","Install CA cert","Intercept & test."],
    link:"https://portswigger.net/burp" },
  Trivy:{ what:"Container & IaC scanner.",
    steps:["Install trivy","trivy image nginx:latest","trivy config ./infra","Export reports."],
    link:"https://aquasecurity.github.io/trivy/" }
};

/* ===== Helper UI ===== */
function Badge({children, tone='brand'}){ const m={ brand:'bg-brand/20 text-brand ring-1 ring-brand/40', green:'bg-green-500/20 text-green-300 ring-1 ring-green-500/40', gray:'bg-white/10 text-white/70 ring-1 ring-white/10', red:'bg-red-500/20 text-red-300 ring-1 ring-red-500/40' };
  return <span className={cx("px-2 py-1 rounded-full text-xs font-semibold", m[tone])}>{children}</span>; }
function ToolChip({name,onClick}){ return <button className="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 text-sm border border-white/10" onClick={onClick}><i className="fa-solid fa-circle-info mr-2"></i>{name}</button>; }
function FullscreenButton({targetRef}){ const go=async()=>{const el=targetRef.current; if(!el) return; if(!document.fullscreenElement) await el.requestFullscreen?.(); else await document.exitFullscreen?.();};
  return <button onClick={go} className="px-3 py-1 rounded bg-white/10 hover:bg-white/20 border border-white/10 text-sm"><i className="fa-solid fa-maximize mr-2"></i>Fullscreen</button>; }

/* ===== Stylish explanation modal (opaque colors) ===== */
function AnswerModal({open, correct, title, detail, onClose}){
  if(!open) return null;
  return (
    <div className="fixed inset-0 z-50 grid place-items-center p-4">
      <div className="absolute inset-0 bg-black/70" onClick={onClose}></div>
      <motion.div
        initial={{scale:.9,opacity:0}} animate={{scale:1,opacity:1}}
        className={cx("rounded-2xl w-full max-w-lg border shadow-2xl",
          correct? "border-green-400":"border-red-400")}
        style={{backgroundColor: correct? '#136f3a' : '#7a1e1e'}}  /* fully opaque */
      >
        <div className="px-6 pt-5 pb-3 border-b border-white/10 flex items-center justify-between">
          <h3 className="text-xl font-bold">{correct? 'Excellent! ✅' : 'Let’s improve 💡'}</h3>
          <button onClick={onClose} aria-label="Close"><i className="fa-solid fa-xmark"></i></button>
        </div>
        <div className="px-6 py-4">
          <div className="font-semibold">{title}</div>
          <div className="mt-3 text-white/95 whitespace-pre-wrap leading-relaxed">{detail}</div>
        </div>
        <div className="px-6 pb-5 flex justify-end">
          <button className="px-4 py-2 rounded bg-white/90 text-black font-semibold" onClick={onClose}>OK</button>
        </div>
      </motion.div>
    </div>
  );
}

/* ===== Terminal (robust local sim) ===== */
function Terminal({script=[]}){
  const [lines,setLines]=useState(["user@academy:~$"]);
  const [v,setV]=useState(""); const [i,setI]=useState(0);
  const boxRef=useRef(null);
  const append=(arr)=>{ setLines(p=>{ const n=[...p, ...arr]; return n.slice(-400); }); };
  useEffect(()=>{ boxRef.current && (boxRef.current.scrollTop = boxRef.current.scrollHeight); },[lines]);

  const run=(cmd)=>{
    const c=(cmd||'').trim();
    if(!c) return;
    const out = [];
    if(/^nmap\b/.test(c)) out.push("Starting Nmap (sim) ...\n22/tcp open ssh\n80/tcp open http\n443/tcp open https");
    else if(/^whoami$/.test(c)) out.push("analyst");
    else if(/^netstat/.test(c)) out.push("tcp 0 0 0.0.0.0:22 LISTEN\n0.0.0.0:80 LISTEN");
    else if(/^help$/.test(c)) out.push("Try: whoami | netstat -tuln | nmap -sS 127.0.0.1");
    else out.push("Command not available in simulation. Try 'help'.");
    append([`user@academy:~$ ${c}`, ...out]); setV("");
  };
  const runScript=async()=>{ for(let j=i;j<script.length;j++){ append([`user@academy:~$ ${script[j].cmd}`, script[j].out]); setI(j+1); await wait(400);} };

  return (
    <div className="rounded-2xl overflow-hidden border border-white/10">
      <div className="bg-black/70 px-4 py-2 flex items-center justify-between">
        <div className="text-xs text-white/60">CyberSec Lab (Simulation)</div>
        <div className="space-x-2">
          <button onClick={()=>{setLines(["user@academy:~$"]); setI(0);}} className="text-xs px-2 py-1 bg-white/10 rounded">Reset</button>
          <button onClick={runScript} className="text-xs px-2 py-1 bg-brand text-black rounded">Run Lesson Sequence</button>
        </div>
      </div>
      <pre ref={boxRef} className="bg-black/60 p-4 min-h-[240px] font-mono text-sm whitespace-pre-wrap overflow-y-auto">{lines.join('\n')}</pre>
      <div className="bg-black/70 p-2 flex gap-2">
        <input className="flex-1 bg-black/40 border border-white/10 rounded px-3 py-2" value={v}
          onChange={e=>setV(e.target.value)} onKeyDown={e=>e.key==='Enter'&&run(v)} placeholder="Type: whoami | netstat -tuln | nmap -sS 127.0.0.1 | help"/>
        <button onClick={()=>run(v)} className="px-4 py-2 rounded bg-white/10 hover:bg-white/20">Run</button>
      </div>
    </div>
  );
}

/* ===== Improved practice widgets ===== */
function MCQuestion({moduleId,qIndex,question,options,onResult}){
  const [selected,setSelected]=useState(null);
  const [locked,setLocked]=useState(false);
  const [modal,setModal]=useState({open:false,correct:false,title:'',detail:''});

  const submit=()=>{
    if(selected==null) return;
    const choice=options[selected];
    const ok=!!choice.correct;
    const best = (options.find(o=>o.correct)||{}).t;
    const detail = (ok? `Why it’s right:\n${choice.explain || choice.why || 'This is the most defensible approach.'}`
                        : `Why that’s not best:\n${choice.explain || choice.why || 'There are safer, more reliable options.'}\n\nBest answer: ${best}`);
    setLocked(true);
    setModal({open:true,correct:ok,title:question,detail});
    onResult(ok, detail, selected);
  };

  return (
    <div>
      <div className="space-y-2">
        {options.map((o,i)=>{
          const isSel = selected===i;
          const isCorrect = locked && o.correct;
          const isWrongSel = locked && isSel && !o.correct;
          return (
            <button
              key={i}
              onClick={()=>!locked && setSelected(i)}
              className={cx(
                "w-full text-left px-4 py-3 rounded border transition",
                !locked && isSel && "bg-white/15 border-white/30",
                !locked && !isSel && "bg-white/5 hover:bg-white/10 border-white/10",
                isCorrect && "bg-green-600 border-green-400",
                isWrongSel && "bg-red-600 border-red-400"
              )}
            >
              {o.t}
            </button>
          );
        })}
      </div>
      <div className="flex gap-2 pt-3">
        {!locked && <button className="px-4 py-2 bg-brand text-black rounded font-semibold disabled:opacity-50" disabled={selected==null} onClick={submit}>Submit</button>}
        {locked && <button className="px-4 py-2 bg-white/10 rounded" onClick={()=>{ setLocked(false); setSelected(null); }}>Try Again</button>}
      </div>
      <AnswerModal open={modal.open} correct={modal.correct} title={modal.title} detail={modal.detail} onClose={()=>setModal({...modal,open:false})}/>
    </div>
  );
}

/* Short Answer with “Best Possible Answer” + Scenario recap */
function ShortAnswer({prompt,rubric,onResult,scenarioText}){
  const [v,setV]=useState(''); const [fb,setFb]=useState(null); const [ok,setOk]=useState(false);
  const grade=(answer, rub)=>{ const a=(answer||'').toLowerCase(); let score=0; const notes=[];
    for(const kw of rub.keywords){ const hit=kw.group.some(g=>a.includes(g.toLowerCase()));
      if(hit){ score+=kw.weight; notes.push(`✓ Mentioned ${kw.group[0]}`);} else { notes.push(`• Include: ${kw.group.slice(0,2).join(' / ')}`);} }
    score=Math.max(0,Math.min(1,score)); const pass=score>=(rub.minScore??.7);
    const bestBlock = `\n\nBest possible answer:\n${rub.modelAnswer}`;
    return { ok:pass, feedback: (pass? "Excellent — you hit the key points." : "Not quite yet.") + `\n\nScenario recap:\n${scenarioText || 'See scenario panel above.'}\n\nTips:\n- ${notes.join('\n- ')}${bestBlock}` };
  };
  const areaRef=useRef(null);
  return (
    <div>
      <div className="text-sm opacity-80 mb-2">{prompt}</div>
      <textarea ref={areaRef} rows={4} className="w-full bg-black/40 border border-white/10 rounded p-3" value={v} onChange={e=>setV(e.target.value)} placeholder="Type your answer…"></textarea>
      <div className="flex gap-2 mt-2">
        <button className="px-4 py-2 bg-brand text-black rounded font-semibold" onClick={()=>{ const res=grade(v,rubric); setFb(res.feedback); setOk(res.ok); onResult(res.ok,res.feedback); }}>Check</button>
        <button className="px-4 py-2 bg-white/10 rounded" onClick={()=>{ setV(''); setFb(null); setOk(false); areaRef.current?.focus(); }}>Reset</button>
      </div>
      {fb && <div className={cx("p-3 mt-2 rounded border", ok? "bg-green-600 border-green-400":"bg-red-600 border-red-400")}><pre className="whitespace-pre-wrap">{fb}</pre></div>}
    </div>
  );
}

/* ===== Discussions & stats ===== */
async function recordItemStat(moduleId, qIdx, pickedIdx, correct){
  const key=`itemstats_${moduleId}`; const data=JSON.parse(localStorage.getItem(key)||'{}');
  const q = data[qIdx] || { total:0, correct:0, options:{} };
  q.total += 1; if (correct) q.correct += 1;
  q.options[pickedIdx] = (q.options[pickedIdx]||0) + 1;
  data[qIdx]=q; localStorage.setItem(key, JSON.stringify(data));
}
async function loadItemStats(moduleId){
  const key=`itemstats_${moduleId}`; return JSON.parse(localStorage.getItem(key)||'{}');
}
async function postThread(moduleId, user, text){
  const msg = { user: user?.email||'Guest', text:text.trim(), ts: Date.now() };
  const key=`thread_${moduleId}`; const cur=JSON.parse(localStorage.getItem(key)||'[]'); cur.push(msg);
  localStorage.setItem(key, JSON.stringify(cur));
}
function ModuleDiscussion({moduleId,user,onClose}){
  const [msgs,setMsgs]=useState([]); const [text,setText]=useState('');
  useEffect(()=>{ const key=`thread_${moduleId}`; setMsgs(JSON.parse(localStorage.getItem(key)||'[]'));
    const i=setInterval(()=>setMsgs(JSON.parse(localStorage.getItem(key)||'[]')), 600); return ()=>clearInterval(i);
  },[moduleId]);
  const send=async()=>{ if(!text.trim()) return; await postThread(moduleId, user, text);
    const key=`thread_${moduleId}`; setMsgs(JSON.parse(localStorage.getItem(key)||'[]')); setText('');
  };
  return <div className="fixed inset-0 z-50 grid place-items-center p-4">
    <div className="absolute inset-0 bg-black/70" onClick={onClose}></div>
    <motion.div initial={{y:40,opacity:0}} animate={{y:0,opacity:1}} className="glass rounded-2xl p-6 w-full max-w-2xl border border-white/10" onMouseDown={e=>e.stopPropagation()}>
      <div className="flex items-center justify-between mb-3"><h3 className="text-xl font-semibold">Discussion — {moduleId}</h3><button onClick={onClose}><i className="fa-solid fa-xmark"></i></button></div>
      <div className="h-72 overflow-y-auto space-y-2 mb-3">{msgs.map((m,i)=><div key={i} className="text-sm"><span className="text-brand">{m.user}:</span> {m.text}</div>)}</div>
      <div className="flex gap-2"><input value={text} onChange={e=>setText(e.target.value)} className="flex-1 bg-black/40 border border-white/10 rounded px-3 py-2" placeholder="Ask or share…"/>
        <button className="px-4 py-2 bg-brand text-black rounded" onClick={send}>Send</button></div>
    </motion.div>
  </div>;
}
function ItemAnalysis({moduleId,onClose}){
  const [stats,setStats]=useState({});
  useEffect(()=>{ (async()=> setStats(await loadItemStats(moduleId)))(); },[moduleId]);
  return <div className="fixed inset-0 z-50 grid place-items-center p-4">
    <div className="absolute inset-0 bg-black/70" onClick={onClose}></div>
    <motion.div initial={{y:40,opacity:0}} animate={{y:0,opacity:1}} className="glass rounded-2xl p-6 w-full max-w-xl border border-white/10" onMouseDown={e=>e.stopPropagation()}>
      <div className="flex items-center justify-between mb-3"><h3 className="text-xl font-semibold">Quiz Item Analysis</h3><button onClick={onClose}><i className="fa-solid fa-xmark"></i></button></div>
      <div className="space-y-3">
        {Object.keys(stats).length===0 && <div className="opacity-70">No cohort data yet.</div>}
        {Object.entries(stats).map(([qIdx, s])=>{
          const p = s.total? (s.correct/s.total*100).toFixed(0) : 0;
          return <div key={qIdx} className="p-3 rounded bg-white/5 border border-white/10">
            <div className="text-sm font-semibold">Q{Number(qIdx)+1} — Difficulty: {p}% correct</div>
            <div className="text-xs opacity-80 mt-1">Responses: {s.total}</div>
            <div className="mt-2 text-sm">Option picks: {Object.entries(s.options||{}).map(([opt, c])=>`[${opt}] ${c}`).join('  ')}</div>
          </div>;
        })}
      </div>
    </motion.div>
  </div>;
}

/* ===== Story blocks ===== */
function StoryBlock({block,onTool}){ useEffect(()=>{try{hljs?.highlightAll()}catch{}},[]);
  if(block.type==='text') return <p className="text-white/85 leading-relaxed">{block.content}</p>;
  if(block.type==='callout') return <div className={cx("p-4 rounded border", block.tone==='warn'?"bg-yellow-500/10 border-yellow-500/30":"bg-white/5 border-white/10")}>{block.content}</div>;
  if(block.type==='timeline') return <ol className="border-l border-white/10 pl-4 space-y-3">{block.items.map((it,i)=><li key={i}><div className="text-brand font-semibold">{it.t}</div><div className="text-white/80">{it.d}</div></li>)}</ol>;
  if(block.type==='diagram') return <div className="code-block border border-white/10"><pre><code>{block.content}</code></pre></div>;
  if(block.type==='info') return <div className="p-4 rounded bg-white/5 border border-white/10">{block.content}</div>;
  if(block.type==='code') return <div className="code-block border border-white/10"><pre><code className={block.lang}>{block.content}</code></pre></div>;
  if(block.type==='chips') return <div className="flex flex-wrap gap-2">{block.items.map(x=><ToolChip key={x} name={x} onClick={()=>onTool(x)}/>)}</div>;
  if(block.type==='checklist') return <ul className="list-disc list-inside space-y-1">{block.items.map((x,i)=><li key={i}>{x}</li>)}</ul>;
  if(block.type==='scene') return (
    <div className="p-4 rounded-xl bg-white/5 border border-white/10">
      <div className="font-semibold">{block.title}</div>
      <p className="text-white/85 mt-2">{block.content}</p>
      {block.hints && <ul className="mt-2 list-disc list-inside text-sm opacity-90">{block.hints.map((h,i)=><li key={i}>{h}</li>)}</ul>}
      {block.code && <div className="code-block border border-white/10 mt-3"><pre><code className={block.lang||'bash'}>{block.code}</code></pre></div>}
    </div>
  );
  return null;
}

/* ===== Scenario panel (pinned) ===== */
function ScenarioBar({module}){
  const scenes = (module.story||[]).filter(b=>b.type==='scene');
  const summary = scenes.map(s=>`• ${s.title}: ${s.content}`).join('\n');
  const [open,setOpen]=useState(true);
  return (
    <div className="sticky top-2 z-20">
      <div className="bg-white/10 backdrop-blur rounded-xl border border-white/10">
        <div className="px-4 py-2 flex items-center justify-between">
          <div className="font-semibold"><i className="fa-solid fa-clipboard-list mr-2 text-brand"></i>Scenario</div>
          <button onClick={()=>setOpen(v=>!v)} className="text-sm px-2 py-1 bg-white/10 rounded">{open?'Hide':'Show'}</button>
        </div>
        {open && <div className="px-4 pb-3"><pre className="whitespace-pre-wrap text-white/90 text-sm">{summary || 'No scenario details provided.'}</pre></div>}
      </div>
    </div>
  );
}

/* ===== Lesson Module (fullscreen) ===== */
function LessonModule({module,user,onClose,onProgress}){
  const [tool,setTool]=useState(null); const [step,setStep]=useState(0);
  const [showDiscuss,setShowDiscuss]=useState(false); const [showStats,setShowStats]=useState(false);
  const [showCheat,setShowCheat]=useState(false);
  const ref=useRef(null); useEffect(()=>{try{hljs?.highlightAll()}catch{}},[step]);

  const giveXP=async(p=10)=>{ await onProgress({xpDelta:p}); };

  const scenarioText = (module.story||[]).filter(b=>b.type==='scene').map(s=>`${s.title}: ${s.content}`).join('\n');

  return <div ref={ref} className="fixed inset-0 z-40 flex">
    <div className="relative flex-1 p-4 md:p-8 bg-brand-dark overflow-y-auto">
      <div className="max-w-5xl mx-auto">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-2xl md:text-3xl font-bold">{module.title}</h2>
          <div className="flex gap-2">
            <button className="px-3 py-1 rounded bg-white/10 hover:bg-white/20 border border-white/10 text-sm" onClick={()=>setShowCheat(true)}><i className="fa-solid fa-terminal mr-2"></i>Linux Cheat Sheet</button>
            <button className="px-3 py-1 rounded bg-white/10 hover:bg-white/20 border border-white/10 text-sm" onClick={()=>setShowDiscuss(true)}><i className="fa-solid fa-comments mr-2"></i>Discussion</button>
            <button className="px-3 py-1 rounded bg-white/10 hover:bg-white/20 border border-white/10 text-sm" onClick={()=>setShowStats(true)}><i className="fa-solid fa-chart-simple mr-2"></i>Item Analysis</button>
            <FullscreenButton targetRef={ref}/>
            <button onClick={onClose} className="px-3 py-1 rounded bg-white/10 hover:bg-white/20 border border-white/10 text-sm"><i className="fa-solid fa-xmark mr-2"></i>Exit</button>
          </div>
        </div>

        <ScenarioBar module={module}/>

        {step===0 && <motion.div initial={{opacity:0,y:20}} animate={{opacity:1,y:0}} className="mt-4">
          <Badge tone="gray">Story Mode</Badge>
          <div className="mt-3 grid gap-4">{module.story.map((b,i)=><StoryBlock key={i} block={b} onTool={setTool}/>)}</div>
          <div className="mt-6 flex gap-2">
            <button onClick={()=>setStep(1)} className="px-4 py-2 rounded bg-brand text-black font-semibold">Begin Practice</button>
          </div>
        </motion.div>}

        {step===1 && <motion.div initial={{opacity:0,y:20}} animate={{opacity:1,y:0}} className="mt-4">
          <Badge>Practice</Badge>
          <div className="mt-3 space-y-6">
            {module.practice.map((p,i)=><div key={i} className="p-4 rounded bg-white/5 border border-white/10">
              <div className="flex items-center justify-between mb-2"><h4 className="font-semibold">{p.title}</h4>
                <Badge tone="gray">{p.mode==='short'?'Short Answer':p.mode==='mc'?'Multiple Choice':p.mode==='dragmatch'?'Drag & Match':'Task'}</Badge></div>
              {p.mode==='mc' && <MCQuestion moduleId={module.id} qIndex={100+i} question={p.title} options={p.options} onResult={(ok)=>{ if(ok) giveXP(10); }}/>}
              {p.mode==='short' && <ShortAnswer prompt={p.prompt} rubric={p.rubric} scenarioText={scenarioText} onResult={(ok)=>{ if(ok) giveXP(12); }}/>}
              {p.mode==='task' && <div className="text-sm opacity-85">{p.instructions}</div>}
            </div>)}
          </div>
          <div className="mt-6 flex gap-2"><button onClick={()=>setStep(0)} className="px-4 py-2 rounded bg-white/10">Back</button>
            <button onClick={()=>setStep(2)} className="px-4 py-2 rounded bg-brand text-black font-semibold">Go to Quiz</button></div>
        </motion.div>}

        {step===2 && <motion.div initial={{opacity:0,y:20}} animate={{opacity:1,y:0}} className="mt-4">
          <Badge tone="green">Final Quiz</Badge>
          <div className="mt-3 space-y-6">{module.quiz.map((q,i)=><div key={i} className="p-4 rounded bg-white/5 border border-white/10">
            <div className="font-semibold mb-3">{q.q}</div>
            <MCQuestion moduleId={module.id} qIndex={i} question={q.q} options={q.answers} onResult={async(ok,_detail,picked)=>{
              await recordItemStat(module.id, i, picked, ok); if(ok) giveXP(15);
            }}/>
          </div>)}</div>
          <div className="mt-6 flex gap-2"><button onClick={()=>setStep(1)} className="px-4 py-2 rounded bg-white/10">Back</button>
            <button onClick={onClose} className="px-4 py-2 rounded bg-green-500 text-black font-semibold">Finish Module</button></div>
        </motion.div>}
      </div>
    </div>
    {tool && <ToolModal tool={tool} onClose={()=>setTool(null)}/>}
    {showDiscuss && <ModuleDiscussion moduleId={module.id} user={user} onClose={()=>setShowDiscuss(false)}/>}
    {showStats && <ItemAnalysis moduleId={module.id} onClose={()=>setShowStats(false)}/>}
    {showCheat && <LinuxCheatSheet onClose={()=>setShowCheat(false)}/>}
  </div>;
}

/* ===== Tool modal ===== */
function ToolModal({tool,onClose}){ if(!tool) return null; const t=TOOL_DB[tool]||TOOL_DB['Wireshark'];
  return <div className="fixed inset-0 z-50 grid place-items-center p-4">
    <div className="absolute inset-0 bg-black/70" onClick={onClose}></div>
    <motion.div initial={{y:40,opacity:0}} animate={{y:0,opacity:1}} className="glass rounded-2xl p-6 w-full max-w-xl border border-white/10" onMouseDown={e=>e.stopPropagation()}>
      <div className="flex items-center justify-between mb-4"><h3 className="text-xl font-semibold">{tool}</h3><button onClick={onClose}><i className="fa-solid fa-xmark"></i></button></div>
      <p className="text-white/80 mb-3">{t.what}</p>
      <ol className="list-decimal list-inside space-y-2 mb-4">{t.steps.map((s,i)=><li key={i}>{s}</li>)}</ol>
      <a className="inline-flex items-center gap-2 px-4 py-2 bg-brand text-black font-semibold rounded-lg" href={t.link} target="_blank" rel="noreferrer"><i className="fa-solid fa-up-right-from-square"></i> Official Site</a>
    </motion.div>
  </div>;
}

/* ===== Linux Cheat Sheet (no single-letter glitch) ===== */
function LinuxCheatSheet({onClose}){
  const SECTIONS = [
    { title:'Navigation & Files', items:[
      ['pwd','Print working directory'],
      ['ls -la','List with details, including hidden'],
      ['cd /path','Change directory'],
      ['cp src dst','Copy file'],
      ['mv src dst','Move/Rename'],
      ['rm file','Remove file'],
      ['rm -r dir','Remove directory recursively'],
      ['touch file','Create empty file'],
      ['mkdir -p path','Create directory tree']
    ]},
    { title:'Permissions', items:[
      ['chmod u+x file','Add execute to user'],
      ['chown user:group file','Change owner/group'],
      ['umask 022','Default permission mask']
    ]},
    { title:'Search & Filters', items:[
      ['grep -R "text" .','Recursive text search'],
      ['find . -name "*.log"','Find files by name'],
      ['awk \'{print $1}\' file','Column extraction'],
      ['sed -n "1,10p" file','Print lines 1..10']
    ]},
    { title:'Processes & Services', items:[
      ['ps aux','List processes'],
      ['top / htop','Interactive monitor'],
      ['kill -9 PID','Force kill process'],
      ['systemctl status service','Service status'],
      ['journalctl -u service','Service logs']
    ]},
    { title:'Networking', items:[
      ['ip a','Interfaces'],
      ['ss -tuln','Listening sockets'],
      ['curl -I https://site','HTTP headers'],
      ['ping -c 4 host','ICMP test'],
      ['traceroute host','Route trace'],
      ['nmap -sV host','Service scan (requires nmap)']
    ]},
    { title:'Archives', items:[
      ['tar -czf out.tgz dir/','Create gzip tar'],
      ['tar -xzf file.tgz','Extract gzip tar'],
      ['zip -r out.zip dir/','Create zip'],
      ['unzip file.zip','Extract zip']
    ]}
  ];
  const [q,setQ]=useState('');
  const inputRef=useRef(null);
  useEffect(()=>{ inputRef.current?.focus(); },[]); // initial focus only (no re-focus per keystroke)

  const list=SECTIONS.map(s=>({...s, items:s.items.filter(([cmd,desc])=>cmd.toLowerCase().includes(q.toLowerCase())||desc.toLowerCase().includes(q.toLowerCase()))})).filter(s=>s.items.length>0);

  const copy=(text)=>{ navigator.clipboard?.writeText(text); };

  return (
    <div className="fixed inset-0 z-50 grid place-items-center p-4">
      <div className="absolute inset-0 bg-black/70" onClick={onClose}></div>
      <motion.div initial={{y:40,opacity:0}} animate={{y:0,opacity:1}} className="glass rounded-2xl p-6 w-full max-w-3xl border border-white/10" onMouseDown={e=>e.stopPropagation()}>
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-xl font-semibold"><i className="fa-solid fa-terminal mr-2"></i>Linux Commands Cheat Sheet</h3>
          <button onClick={onClose}><i className="fa-solid fa-xmark"></i></button>
        </div>
        <input ref={inputRef} value={q} onChange={e=>setQ(e.target.value)} className="w-full bg-black/40 border border-white/10 rounded px-3 py-2" placeholder="Search commands or descriptions…" />
        <div className="grid md:grid-cols-2 gap-4 mt-4 max-h-[60vh] overflow-y-auto pr-1">
          {list.map((s,si)=><div key={si} className="p-3 rounded-lg bg-white/5 border border-white/10">
            <div className="font-semibold mb-2">{s.title}</div>
            <ul className="space-y-2">
              {s.items.map(([cmd,desc],i)=><li key={i} className="flex items-center justify-between gap-2">
                <div>
                  <code className="bg-black/40 px-2 py-1 rounded">{cmd}</code>
                  <div className="text-xs opacity-80 mt-1">{desc}</div>
                </div>
                <button className="px-2 py-1 text-xs bg-white/10 rounded hover:bg-white/20" onClick={()=>copy(cmd)}>Copy</button>
              </li>)}
            </ul>
          </div>)}
          {list.length===0 && <div className="opacity-80 text-sm">No matches.</div>}
        </div>
      </motion.div>
    </div>
  );
}

/* ===== Course scaffolding (trimmed) ===== */
const FOUNDATIONS_10=[
  "The Internet Under Attack","Recon & Network Basics","Web App Security 101","Authentication & Authorization",
  "Intro to Cryptography","Secure Coding (Top 10)","Linux Security Fundamentals","Windows Security Fundamentals",
  "Cloud Security Basics","Foundations Capstone"
];
const NETWORK_10=[
  "Packet Capture Triage (Wireshark + Zeek)","TCP/IP Deep Dive","Subnetting & Routing Basics","Switching & VLANs",
  "DNS In Depth","TLS Handshake & PKI","Firewalls & ACLs","IDS/IPS Concepts","BGP Basics & Security (Concepts)","Network Capstone"
];
const SQL_10=[
  "SQL Security Fundamentals","Relational Modeling & Keys","SQL Basics SELECT/WHERE/JOIN","Transactions & Isolation Levels",
  "Privileges/Roles/Least Privilege","Parameterization & ORM Safety","Stored Procedures Safeguards",
  "Audit Logging & Triggers (Concepts)","Encryption at Rest & in Transit","SQL Capstone"
];

/* A fully authored example (Network #1 + SQL #1) */
const AUTHORED = {
  network: {
    "Packet Capture Triage (Wireshark + Zeek)": {
      id:'net-1', title:'Packet Capture Triage (Wireshark + Zeek)',
      story:[
        {type:'scene', title:'Briefing', content:"It’s 16:55. A critical release deployed at 16:30. Support phones light up: intermittent timeouts. You get a 5-minute PCAP from the API gateway."},
        {type:'chips', items:['Wireshark','Zeek']},
        {type:'scene', title:'Hypotheses', content:"Is it network congestion, TLS handshake failures after a cert change, or app latency? We don’t guess — we validate.", hints:['Check packet loss/retrans','Protocol mix changes','HTTP 5xx spikes']},
        {type:'timeline', items:[
          {t:'00:00', d:'Wireshark → Statistics → Protocol Hierarchy (is traffic mix normal?)'},
          {t:'00:02', d:'Conversations/Endpoints → top talkers, RST/FIN spikes'},
          {t:'00:03', d:'zeek -r capture.pcap → conn.log, dns.log, http.log summary'},
          {t:'00:04', d:'Draft a 3-bullet incident note for leadership'}
        ]},
        {type:'callout', tone:'warn', content:'Simulated only. Never test on systems you don’t own or have permission to assess.'}
      ],
      practice:[
        {mode:'mc', title:'Fastest “what’s happening” panel in Wireshark?', options:[
          {t:'Statistics → Protocol Hierarchy', correct:true, explain:'One glance shows protocol mix & volumes.'},
          {t:'Edit → Preferences', correct:false, explain:'Not triage.'},
          {t:'Help → About', correct:false, explain:'Informational only.'},
        ]},
        {mode:'short', title:'Risk thinking', prompt:'State the primary risk and the one control that best mitigates it for this scenario.', rubric:{
          minScore:.6, keywords:[{group:['risk','impact'],weight:.3},{group:['mitigate','prevent','control'],weight:.4},{group:['monitor','logs','verify'],weight:.3}],
          modelAnswer:"Primary risk: prolonged customer impact while chasing the wrong root cause. Control: structured triage — Wireshark proto/flows for loss & resets; Zeek conn/http for outliers; only then test a minimal, reversible config change behind a feature flag."
        }}
      ],
      quiz:[
        {q:'Which quick metric indicates scanning?', answers:[
          {t:'Many destination ports from one source in short bursts', correct:true, explain:'That pattern is classic scanning.'},
          {t:'TLS version variety', correct:false, explain:'Not definitive.'},
          {t:'One long TCP session', correct:false, explain:'Likely normal transfer.'}
        ]}
      ]
    }
  },
  sql: {
    "SQL Security Fundamentals": {
      id:'sql-1', title:'SQL Security Fundamentals',
      story:[
        {type:'scene', title:'Briefing', content:"The login page leaks stack traces under load. Error shows a SELECT built with string concatenation."},
        {type:'diagram', content:`/login -> api -> db\n"SELECT * FROM users WHERE name = '"+user+"' AND pass='"+pw+"';"`},
        {type:'scene', title:'Action', content:'Replace with prepared statements; minimize error leakage; add security logging.', code:`-- Parameterized example (PostgreSQL)\nPREPARE authPlan (text, text) AS\n  SELECT id FROM users WHERE name=$1 AND password_hash = crypt($2, password_hash);\nEXECUTE authPlan($1,$2);`}
      ],
      practice:[
        {mode:'short', title:'Risk thinking', prompt:'State the primary risk and the one control that best mitigates it for this scenario.', rubric:{
          minScore:.6, keywords:[{group:['injection','sql'],weight:.4},{group:['parameter','prepared','bind'],weight:.4},{group:['errors','leak','logging'],weight:.2}],
          modelAnswer:"Primary risk: SQL injection enabling auth bypass/data exposure. Control: parameterized queries (prepared statements/ORM binds) everywhere; standardize error handling (no stack traces) and log auth failures server-side."
        }}
      ],
      quiz:[
        {q:'Parameterization works for…', answers:[
          {t:'SELECT, INSERT, UPDATE, DELETE', correct:true, explain:'All DML can bind params safely.'},
          {t:'Only SELECT', correct:false, explain:'Not limited to SELECT.'},
          {t:'Only WHERE clauses', correct:false, explain:'Also values and sets.'}
        ]}
      ]
    }
  }
};
function defaultModule(id, title) {
  return {
    id, title,
    story:[
      {type:'scene', title:'Briefing', content:`Mission: ${title}. You’ll approach this the way a professional team would — stepwise, safe, reversible.`},
      {type:'callout', tone:'warn', content:'Simulated only. Never test on systems you don’t own or have permission to assess.'}
    ],
    practice:[
      {mode:'mc', title:'First action?', options:[
        {t:'Gather context & verify signal', correct:true, explain:'Evidence-first prevents false positives and bad changes.'},
        {t:'Change configs in prod', correct:false, explain:'Risky without triage.'},
        {t:'Ignore for later', correct:false, explain:'Delay raises risk.'},
      ]},
      {mode:'short', title:'Risk thinking', prompt:'State the primary risk and the one control that best mitigates it for this scenario.', rubric:{
        minScore:.6, keywords:[{group:['risk','impact'],weight:.3},{group:['mitigate','prevent','control'],weight:.4},{group:['monitor','logs','verify'],weight:.3}],
        modelAnswer:"Primary risk: unintended service impact due to changes without triage. Control: evidence-driven change control — observe telemetry, test minimal reversible change, and monitor rollback criteria."
      }},
    ],
    quiz:[
      {q:'What principle reduces change risk?', answers:[
        {t:'Small, reversible steps w/ evidence', correct:true, explain:'Limits blast radius and keeps you guided by data.'},
        {t:'Big-bang changes', correct:false, explain:'Hard to roll back and diagnose.'},
        {t:'Gut feeling', correct:false, explain:'We want data-driven operations.'},
      ]}
    ]
  };
}

function buildTrack(name, titles){
  const out=[]; for (let i=0;i<titles.length;i++){
    const t=titles[i]; const authored = AUTHORED[name]?.[t];
    const id = authored?.id || `${name}-${i+1}`;
    out.push(authored ? authored : defaultModule(id, t));
  }
  return out;
}
const TRACKS = {
  foundations: buildTrack('foundations', FOUNDATIONS_10),
  network:     buildTrack('network', NETWORK_10),
  sql:         buildTrack('sql', SQL_10),
};

/* ===== Unlock logic (5-at-a-time) ===== */
function getCompletedCount(progressTrack){ return Object.keys(progressTrack||{}).length; }
function isPhaseLocked(indexInTrack, progressTrack){
  const completed = getCompletedCount(progressTrack);
  if(indexInTrack >= 5 && completed < 5) return true;
  return false;
}
function hasPrereqsDone(module, progressTrack){ const req=module.prereq||[]; return req.every(r=>progressTrack[r]); }

/* ===== Course map ===== */
function CourseMap({title,trackKey,nodes=[],progress={},onOpen}){
  return <div className="p-4 rounded-2xl bg-white/5 border border-white/10">
    <div className="flex items-center justify-between mb-3"><h3 className="text-xl font-semibold">{title}</h3>
      <Badge tone="gray">{Object.keys(progress).length} completed</Badge></div>
    <div className="grid sm:grid-cols-2 md:grid-cols-3 gap-3">
      {nodes.map((n,idx)=>{ const done=progress[n.id]; const lockedByPrereq = n.prereq && n.prereq.length>0 && !hasPrereqsDone(n,progress);
        const lockedByPhase = isPhaseLocked(idx, progress);
        const locked = lockedByPrereq || lockedByPhase;
        return <button key={n.id||idx} disabled={locked}
          onClick={()=>!locked && onOpen(n)}
          className={cx("text-left p-4 rounded-xl border transition", locked?"bg-white/5 border-white/10 opacity-50 cursor-not-allowed":
            done?"bg-green-600 border-green-400":"bg-white/5 border-white/10 hover:bg-white/10")}>
          <div className="flex items-start justify-between"><span className="font-semibold">{n.title}</span>
            {locked?<i className="fa-solid fa-lock text-white/60"></i>: done?<i className="fa-solid fa-check text-green-300"></i>:<i className="fa-solid fa-book-open text-brand"></i>}
          </div>
          {lockedByPhase && <div className="text-xs mt-1 opacity-70">Locked: complete first 5 modules</div>}
          {n.prereq?.length>0 && <div className="text-xs mt-1 opacity-70">Prereq: {n.prereq.join(', ')}</div>}
        </button>;
      })}
    </div>
  </div>;
}

/* ===== Auth modal ===== */
function AuthModal({onClose,onAuthed}){
  const [tab,setTab]=useState('login'); const [email,setEmail]=useState(''); const [pass,setPass]=useState(''); const [err,setErr]=useState('');
  return <div className="fixed inset-0 z-50 grid place-items-center p-4">
    <div className="absolute inset-0 bg-black/70" onClick={onClose}></div>
    <motion.div initial={{scale:.9,opacity:0}} animate={{scale:1,opacity:1}} className="glass rounded-2xl p-6 w-full max-w-md border border-white/10" onMouseDown={e=>e.stopPropagation()}>
      <div className="flex items-center justify-between mb-4">
        <div className="flex gap-2">
          <button onClick={()=>setTab('login')} className={cx("px-3 py-1 rounded", tab==='login'?"bg-brand text-black":"bg-white/10")}>Log In</button>
          <button onClick={()=>setTab('signup')} className={cx("px-3 py-1 rounded", tab==='signup'?"bg-brand text-black":"bg-white/10")}>Sign Up</button>
        </div>
        <button onClick={onClose}><i className="fa-solid fa-xmark"></i></button>
      </div>
      {err && <div className="mb-3 p-2 rounded bg-red-600 border border-red-400 text-sm">{err}</div>}
      <div className="space-y-3">
        <div><label className="text-sm block opacity-80 mb-1">Email</label>
          <input type="email" className="w-full bg-black/40 border border-white/10 rounded px-3 py-2" value={email} onChange={e=>setEmail(e.target.value)}/></div>
        <div><label className="text-sm block opacity-80 mb-1">Password</label>
          <input type="password" className="w-full bg-black/40 border border-white/10 rounded px-3 py-2" value={pass} onChange={e=>setPass(e.target.value)}/></div>
        <button className="w-full px-4 py-2 bg-brand text-black rounded font-semibold" onClick={async()=>{
          try { const fn=tab==='login'? signIn: signUp; const u=await fn(email,pass); appState.user=u;
            const existing=await loadProgress(u.uid); onAuthed(u,existing); onClose(); } catch(e){ setErr(e.message); }
        }}>{tab==='login'?'Log In':'Create Account'}</button>
        {!CONFIG.USE_FIREBASE && <div className="text-xs opacity-70 text-center">Demo auth active. Enable Firebase in config for real auth.</div>}
      </div>
    </motion.div>
  </div>;
}

/* ===== App ===== */
function App(){
  const [page,setPageState]=useState(getRouteFromHash());
  const [stack,setStack]=useState(['home']); // in-app stack
  const setPage=(p, push=true)=>{ setPageState(p); if(push) setStack(s => [...s, p]); navTo(p); };
  useEffect(()=>{ const onHash=()=>setPageState(getRouteFromHash()); window.addEventListener('hashchange', onHash); return ()=>window.removeEventListener('hashchange', onHash); },[]);

  const [showAuth,setShowAuth]=useState(false);
  const [user,setUser]=useState(null);
  const [progress,setProgress]=useState({ xp:0, badges:[], foundations:{}, network:{}, sql:{} });
  const [activeTrack,setActiveTrack]=useState('foundations');

  useEffect(()=>{ initFirebaseIfNeeded(); },[]);
  useEffect(()=>{ try{ hljs?.highlightAll() }catch{} },[page,activeTrack]);

  const giveXP=(n)=> setProgress(p=>({...p, xp:(p.xp||0)+n }));
  const openModule=(m,trackKey)=>{
    const mount=document.createElement('div'); document.body.appendChild(mount);
    const onClose=()=>{ root.unmount(); mount.remove(); setPage('learn'); setProgress(p=>({...p, [trackKey]:{...p[trackKey],[m.id]:true}})); giveXP(20); };
    const onProgress=async({xpDelta=0})=>giveXP(xpDelta);
    const root=ReactDOM.createRoot(mount);
    root.render(<LessonModule module={m} user={user} onClose={onClose} onProgress={onProgress} />);
  };

  const TRACK_LABELS={ foundations:'Foundations', network:'Network', sql:'Databases (SQL)' };

  const modulesDone = ['foundations','network','sql'].reduce((a,k)=>a+Object.keys(progress[k]).length,0);
  const totalModules = Object.values(TRACKS).reduce((a,v)=>a+v.length,0);
  const xpPct=Math.min(100, Math.round((modulesDone / totalModules) * 100));

  const goBackInApp = ()=>{ setStack(s=>{
    if(s.length<=1) return s;
    const next=[...s]; next.pop(); const prev=next[next.length-1]||'home';
    setPageState(prev); navTo(prev);
    return next;
  }); };

  return <div className="min-h-screen flex flex-col">
    <header className="sticky top-0 z-30">
      <div className="glass border-b border-white/10">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            {/* Brand Logo (Shield) */}
            <svg aria-hidden="true" className="h-8 w-8 text-brand" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l7 3v6c0 5-3.5 9.5-7 11-3.5-1.5-7-6-7-11V5l7-3zM9.5 11a2.5 2.5 0 115 0v1h1v4h-7v-4h1v-1zm2.5-1a1 1 0 100 2 1 1 0 000-2z"/>
            </svg>
            <div className="text-lg font-bold">CyberSec Academy</div>
            <Badge>Story → Practice → Quiz</Badge>
            {stack.length>1 && <button onClick={goBackInApp} className="ml-2 px-2 py-1 text-sm rounded bg-white/10 hover:bg-white/20"><i className="fa-solid fa-arrow-left mr-1"></i>Back</button>}
          </div>
          <nav className="hidden md:flex items-center gap-2">
            {['home','learn','maps','roles','labs','challenges','cheats','dashboard'].map(p =>
              <button key={p} onClick={()=>setPage(p)} className={cx("px-3 py-2 rounded text-sm", page===p?"bg-white/15":"hover:bg-white/10")}>
                {p==='maps'?'Course Maps':p==='cheats'?'Cheat Sheets':p[0].toUpperCase()+p.slice(1)}
              </button>)}
          </nav>
          <div className="flex items-center gap-2">
            {user? (<><Badge tone="green">{user.email}</Badge><button className="px-3 py-2 bg-white/10 rounded" onClick={async()=>{await signOut(); setUser(null);}}>Sign out</button></>)
                 : (<button className="px-3 py-2 bg-brand text-black rounded font-semibold" onClick={()=>setShowAuth(true)}>Log in / Sign up</button>)}
          </div>
        </div>
      </div>
      <div className="h-1 bg-white/10"><div className="h-1 bg-brand" style={{width:`${xpPct}%`}}></div></div>
    </header>

    <main className="flex-1">
      {page==='home' && <section className="relative overflow-hidden">
        <div className="absolute inset-0 heroBg"></div>
        <div className="max-w-7xl mx-auto px-4 py-16 relative">
          <div className="grid md:grid-cols-2 gap-10 items-center">
            <motion.div initial={{opacity:0,y:20}} animate={{opacity:1,y:0}}>
              <h1 className="text-4xl md:text-5xl font-black leading-tight">Learn cybersecurity the way <span className="text-brand">professionals</span> do.</h1>
              <p className="mt-4 text-white/80 text-lg">Immersive stories → hands-on labs → graded practice → community → badges.</p>
              <div className="mt-6 flex gap-3"><button onClick={()=>setPage('learn')} className="px-5 py-3 bg-brand text-black rounded-xl font-bold">Start Learning</button>
                <button onClick={()=>setPage('roles')} className="px-5 py-3 bg-white/10 rounded-xl">Pick a Role Path</button></div>
            </motion.div>
            <motion.div initial={{opacity:0,scale:.95}} animate={{opacity:1,scale:1}} transition={{delay:.1}}>
              <Terminal script={[
                {cmd:'whoami', out:'analyst'},
                {cmd:'nmap -sS 192.168.1.0/24', out:'22/tcp open ssh\n80/tcp open http\n443/tcp open https'}
              ]}/>
            </motion.div>
          </div>
        </div>
      </section>}

      {page==='learn' && <section className="max-w-7xl mx-auto px-4 py-10 space-y-6">
        <div className="flex items-center justify-between">
          <div className="flex flex-wrap gap-2">{Object.keys(TRACK_LABELS).map(k=>
            <button key={k} onClick={()=>{ setActiveTrack(k); setPage('learn'); }} className={cx("px-3 py-2 rounded border text-sm", activeTrack===k? "bg-brand text-black border-brand":"bg-white/5 border-white/10 hover:bg-white/10")}>{TRACK_LABELS[k]}</button>)}
          </div>
          <div className="text-sm opacity-70">{Object.keys(progress[activeTrack]).length} / {TRACKS[activeTrack].length} completed</div>
        </div>
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">{TRACKS[activeTrack].map((m,idx)=>{
          const done=!!progress[activeTrack][m.id];
          const lockedByPhase = isPhaseLocked(idx, progress[activeTrack]);
          const locked = lockedByPhase;
          return <motion.div key={m.id} whileHover={{y:-2}} className={cx("p-4 rounded-2xl border", locked? "bg-white/5 border-white/10 opacity-50": done? "bg-green-600 border-green-400":"bg-white/5 border-white/10")}>
            <div className="flex items-start justify-between gap-3">
              <div><h3 className="font-semibold">{m.title}</h3>
                <div className="mt-1 text-sm opacity-70">
                  {lockedByPhase ? 'Locked: complete first 5 modules' : (done?'Completed':'Story → Practice → Quiz')}
                </div></div>
              {locked?<i className="fa-solid fa-lock text-white/60"></i>: done?<i className="fa-solid fa-check text-green-200"></i>:<i className="fa-solid fa-book-open text-brand"></i>}
            </div>
            <div className="mt-4 flex gap-2">
              {!locked && (!done
                ? <button className="px-3 py-2 bg-brand text-black rounded-lg font-semibold" onClick={()=>openModule(m,activeTrack)}>Start</button>
                : <button className="px-3 py-2 bg-white/10 rounded-lg" onClick={()=>openModule(m,activeTrack)}>Review</button>)}
            </div>
          </motion.div>;
        })}</div>
      </section>}

      {page==='maps' && <section className="max-w-7xl mx-auto px-4 py-10 space-y-6">
        <h2 className="text-2xl font-bold">Course Maps (with phased unlocks)</h2>
        <div className="grid lg:grid-cols-2 gap-6 mt-6">
          {Object.entries({Foundations:'foundations','Network':'network','Databases (SQL)':'sql'}).map(([label,key])=>
            <CourseMap key={key} title={label} trackKey={key}
              nodes={TRACKS[key].map((m,idx)=>({id:m.id,title:m.title,prereq:m.prereq,index:idx}))}
              progress={progress[key]}
              onOpen={(n)=>openModule(TRACKS[key].find(m=>m.id===n.id),key)}/>)}
        </div>
      </section>}

      {page==='labs' && <section className="max-w-5xl mx-auto px-4 py-10 space-y-6">
        <h2 className="text-2xl font-bold">Interactive Labs</h2>
        <Terminal script={[
          {cmd:'whoami', out:'analyst'},
          {cmd:'netstat -tuln', out:'tcp 0 0 0.0.0.0:22 LISTEN\n0.0.0.0:80 LISTEN'},
          {cmd:'nmap -sV -O 127.0.0.1', out:'22/tcp open ssh OpenSSH 8.9\nOS details: Linux 5.x'}
        ]}/>
        <div className="text-sm opacity-70">Using safe, local simulations.</div>
      </section>}

      {page==='cheats' && <section className="max-w-6xl mx-auto px-4 py-10 space-y-6">
        <h2 className="text-2xl font-bold">Cheat Sheets</h2>
        <div className="p-4 rounded-2xl bg-white/5 border border-white/10">
          <div className="flex items-center justify-between">
            <div className="text-lg font-semibold"><i className="fa-solid fa-terminal mr-2"></i>Linux Commands</div>
            <button className="px-3 py-2 bg-brand text-black rounded" onClick={()=>{
              const mount=document.createElement('div'); document.body.appendChild(mount);
              const root=ReactDOM.createRoot(mount);
              const close=()=>{root.unmount(); mount.remove();};
              root.render(<LinuxCheatSheet onClose={close}/>);
            }}>Open</button>
          </div>
          <p className="text-white/80 mt-2 text-sm">Searchable, copy-to-clipboard quick references.</p>
        </div>
      </section>}

      {page==='dashboard' && <section className="max-w-7xl mx-auto px-4 py-10 space-y-6">
        <h2 className="text-2xl font-bold">Your Dashboard</h2>
        <div className="grid md:grid-cols-4 gap-6">
          <div className="p-4 rounded-2xl bg-white/5 border border-white/10"><div className="text-sm opacity-70">Total XP</div><div className="text-4xl font-black mt-2">{progress.xp||0}</div></div>
          {Object.keys(TRACK_LABELS).map(k=><div key={k} className="p-4 rounded-2xl bg-white/5 border border-white/10">
            <div className="text-sm opacity-70">{TRACK_LABELS[k]}</div>
            <div className="text-3xl font-black mt-2">{Object.keys(progress[k]).length}/{TRACKS[k].length}</div>
          </div>)}
        </div>
      </section>}
    </main>

    <footer className="mt-12 border-top border-white/10">
      <div className="max-w-7xl mx-auto px-4 py-10 grid md:grid-cols-3 gap-6">
        <div><div className="font-bold text-lg">CyberSec Academy</div><p className="text-white/70 mt-2">Learn clearly. Practice safely. Apply for real.</p></div>
        <div><div className="font-semibold">Tools</div><div className="mt-3 flex flex-wrap gap-2">{Object.keys(TOOL_DB).map(k=><ToolChip key={k} name={k} onClick={()=>alert('Open a module to see tool explainers with steps & links.')}/>)}</div></div>
        <div><div className="font-semibold">Get Started</div><div className="mt-3 flex gap-2">
          <button className="px-3 py-2 bg-brand text-black rounded" onClick={()=>setPage('learn')}>Start Learning</button>
          <button className="px-3 py-2 bg-white/10 rounded" onClick={()=>setPage('maps')}>Course Maps</button>
        </div></div>
      </div>
    </footer>

    {/* Auth modal */}
    {showAuth && <AuthModal onClose={()=>setShowAuth(false)} onAuthed={(u,existing)=>{ setUser(u); if(existing) setProgress(existing); }}/>}
  </div>;
}

/* ===== Boot ===== */
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>

