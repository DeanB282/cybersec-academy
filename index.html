<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CyberSec Academy — Learn, Practice, Master</title>

  <!-- Tailwind (CDN JIT) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: '#00d4ff', dark: '#0c1e3e', accent: '#8a2be2', danger:'#ef4444', ok:'#22c55e' }
          },
          boxShadow: {
            glass: '0 8px 30px rgba(2,8,23,.35)',
          },
          backgroundImage: {
            'grid': "linear-gradient(rgba(255,255,255,.04) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,.04) 1px, transparent 1px)",
          }
        }
      }
    }
  </script>

  <!-- Icons & Syntax Highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>window.addEventListener('DOMContentLoaded', ()=> hljs.highlightAll())</script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Framer Motion -->
  <script src="https://unpkg.com/framer-motion/dist/framer-motion.umd.js"></script>

  <!-- Firebase (compat builds for simple CDN usage) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    html, body, #root { height: 100%; }
    .glass {
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(12,30,62,.65), rgba(12,30,62,.35));
    }
    .dot {
      background: radial-gradient(circle at 30% 30%, rgba(0,212,255,.8), transparent 40%),
                  radial-gradient(circle at 70% 70%, rgba(138,43,226,.6), transparent 45%);
    }
    .bg-grid { background-size: 48px 48px, 48px 48px; }
    .code-block { border-radius: 12px; overflow: hidden; }
    .scroll-snap-y { scroll-snap-type: y proximity; }
    .snap-child { scroll-snap-align: start; }
    @keyframes pulse-ring {
      0% { transform: scale(.8); opacity: .6; }
      80%, 100% { transform: scale(1.8); opacity: 0; }
    }
  </style>
</head>
<body class="bg-brand-dark text-white selection:bg-brand/40">
<div id="root"></div>

<script type="text/babel">
/** ==================
 *  Global Config
 *  ================== */
const CONFIG = {
  THEME_DEFAULT: 'dark',
  USE_FIREBASE: true, // set to true when you paste your firebase config below
  FIREBASE_CONFIG: {
    // ⬇️ paste your Firebase project config or leave as-is to run in local demo mode
    // apiKey: "YOUR_API_KEY",
    // authDomain: "YOUR_PROJECT.firebaseapp.com",
    // projectId: "YOUR_PROJECT",
    // storageBucket: "YOUR_PROJECT.appspot.com",
    // messagingSenderId: "SENDER_ID",
    // appId: "APP_ID"
  },
  USE_SQL_BACKEND: false, // set true if you want to send progress to your own Node/SQL backend
  SQL_BACKEND_URL: "http://localhost:3000", // your server.js base URL
};

/** ==================
 *  Utilities
 *  ================== */
const { useState, useEffect, useRef, useMemo } = React;
const { motion, AnimatePresence } = window["framer-motion"];
const cx = (...c) => c.filter(Boolean).join(' ');
const wait = (ms)=> new Promise(r=>setTimeout(r, ms));
const escapeHtml = (s='') => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

/** Random ID */
const rid = (p='id') => `${p}_${Math.random().toString(36).slice(2,9)}`;

/** Local demo hashing for auth fallback */
async function sha256(txt) {
  const enc = new TextEncoder().encode(txt);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/** ==================
 *  Tool Knowledge Base
 *  ================== */
const TOOL_DB = {
  Wireshark: {
    what: "Wireshark is a network protocol analyzer that lets you capture and inspect packets flowing through an interface.",
    steps: [
      "Go to the official website (wireshark.org).",
      "Download the installer for your OS (Windows/macOS/Linux).",
      "Install using defaults; on Windows, allow Npcap driver.",
      "Launch Wireshark, choose an interface (e.g., Ethernet/Wi-Fi), click Start to capture."
    ],
    link: "https://www.wireshark.org/",
  },
  "Burp Suite": {
    what: "Burp Suite is a web security testing platform for intercepting, modifying, and scanning HTTP/S traffic.",
    steps: [
      "Visit ports­wigger.net/burp and download Community/Pro.",
      "Install Java if prompted; run Burp.",
      "Configure your browser to use Burp's proxy (127.0.0.1:8080).",
      "Install the Burp CA certificate in the browser for HTTPS interception."
    ],
    link: "https://portswigger.net/burp",
  },
  Nmap: {
    what: "Nmap is a powerful network scanner used for host discovery, port scanning, and service/OS detection.",
    steps: [
      "On Linux/macOS: install via package manager (apt, brew).",
      "On Windows: download installer from nmap.org.",
      "Run basic scan: nmap -sS 192.168.1.0/24",
      "Detect versions: nmap -sV target; OS: nmap -O target"
    ],
    link: "https://nmap.org/",
  },
  "John the Ripper": {
    what: "John is a fast password cracker for hashes (e.g., MD5, bcrypt).",
    steps: [
      "Install from openwall.com/john or via package manager.",
      "Place hashes in a file, one per line.",
      "Run: john --format=raw-md5 --wordlist=rockyou.txt hashes.txt",
      "Show results: john --show hashes.txt"
    ],
    link: "https://www.openwall.com/john/",
  }
};

/** ==================
 *  Content Model
 *  ================== */
// Story-first lessons, then practice, then quiz.
// Each section supports: text, code, info, chips (tools), and inline tasks.
const FUNDAMENTALS = [
  {
    id: 'fun-1',
    title: 'Module 1 — The Internet Under Attack',
    story: [
      {type:'text', content: "Welcome, Analyst. Your company’s helpdesk is flooded: users can’t log in, web pages crawl, and the CEO’s email shows strange logins. You’ve just been paged."},
      {type:'text', content: "Your mission today is to understand the *CIA triad*, spot common threats, and triage the incident."},
      {type:'chips', items:['Wireshark','Nmap']},
      {type:'info', content: "CIA Triad = Confidentiality (only right people see data), Integrity (data stays accurate), Availability (systems are up). Attacks often hit at least one."},
      {type:'code', lang:'bash', content:`# Quick triage commands
whoami
netstat -tuln
ps aux | head
sudo systemctl status ssh`},
    ],
    practice: [
      {type:'task', title:'Drag & Match Threats', mode:'dragmatch',
       pairs:[
         ['Phishing','Tricking users to reveal credentials'],
         ['Malware','Malicious software that harms systems'],
         ['DDoS','Flooding a service to make it unavailable'],
         ['SQL Injection','Injecting SQL to manipulate DB queries'],
       ]},
      {type:'short', title:'Short Answer: Explain Availability in one sentence.',
       rubric:{
         minScore: 0.7,
         keywords: [
           {group:['available','availability','uptime'], weight:.5},
           {group:['authorized','users','legitimate','intended'], weight:.2},
           {group:['access','accessing','use'], weight:.3},
         ],
         modelAnswer: "Availability means authorized users can reliably access systems and data when needed."
       }
      }
    ],
    quiz: [
      {q:'Which best describes the CIA triad?',
       answers:[
         {t:'Central Intelligence Agency methods', correct:false, why:'A classic trap — here CIA means confidentiality, integrity, availability.'},
         {t:'Confidentiality, Integrity, Availability', correct:true, why:'Exactly. These are the three pillars.'},
         {t:'Cyber Incident Assessment', correct:false, why:'Not a standard term.'},
         {t:'Computer Information Assurance', correct:false, why:'Close-sounding, but not the triad.'},
       ]},
    ]
  },
  {
    id: 'fun-2',
    title: 'Module 2 — Reconnaissance & Network Basics',
    story: [
      {type:'text', content:"Incidents often begin with recon. You’ll use Nmap to map the environment, then validate with Wireshark."},
      {type:'chips', items:['Nmap','Wireshark']},
      {type:'code', lang:'bash', content:`# SYN scan a subnet
nmap -sS 192.168.1.0/24

# Version/OS detection
nmap -sV -O 192.168.1.1

# Capture packets while you scan (different host)
sudo wireshark`},
    ],
    practice: [
      {type:'task', title:'What does -sS vs -sV do?', mode:'mc',
       options:[
         {t:'-sS stealth SYN scan; -sV version detection', correct:true, why:'SYN scan sends half-open SYN packets; -sV probes service versions.'},
         {t:'-sS version detection; -sV stealth scan', correct:false, why:'These are reversed.'},
         {t:'Both are OS detection modes', correct:false, why:'OS detection is -O.'},
       ]},
      {type:'short', title:'Name two signs of port scanning in logs.',
       rubric:{
         minScore:.6,
         keywords:[
           {group:['many','multiple','repeated'], weight:.2},
           {group:['ports','port'], weight:.3},
           {group:['short','quick','rapid','burst','time'], weight:.2},
           {group:['across','different','hosts','servers','IPs'], weight:.3}
         ],
         modelAnswer:"Repeated rapid connections to many ports (often across multiple hosts) from a single source."
       }
      }
    ],
    quiz: [
      {q:'You see repeated connection attempts to many ports across servers. What’s likely happening?',
       answers:[
         {t:'Phishing Attack', correct:false, why:'Phishing targets people, not ports.'},
         {t:'DDoS Attack', correct:false, why:'DDoS is volume to one/few services, not port sweeps.'},
         {t:'Port Scanning', correct:true, why:'Exactly — broad probes across many ports.'},
         {t:'SQL Injection', correct:false, why:'SQLi targets web/database inputs, not port activity.'},
       ]},
    ]
  },
  // Add many more modules similarly…
];

/** Example Red/Blue course maps */
const RED_COURSE = [
  { id:'r1', title:'Recon & OSINT', type:'red', prereq:[] },
  { id:'r2', title:'Initial Access (Web)', type:'red', prereq:['r1'] },
  { id:'r3', title:'Lateral Movement', type:'red', prereq:['r2'] },
  { id:'r4', title:'Privilege Escalation', type:'red', prereq:['r3'] },
  { id:'r5', title:'Post-Exfil & Cleanup', type:'red', prereq:['r4'] },
];

const BLUE_COURSE = [
  { id:'b1', title:'Log Fundamentals', type:'blue', prereq:[] },
  { id:'b2', title:'Detection Engineering', type:'blue', prereq:['b1'] },
  { id:'b3', title:'SIEM Triage & Hunting', type:'blue', prereq:['b2'] },
  { id:'b4', title:'Incident Response', type:'blue', prereq:['b3'] },
  { id:'b5', title:'Threat Intel & Purple Ops', type:'blue', prereq:['b4'] },
];

/** ==================
 *  Services: Auth & Storage
 *  ================== */
const appState = {
  firebaseApp: null,
  auth: null,
  db: null,
  user: null,
  demoUsers: {}, // email -> {hash, uid}
};

function initFirebaseIfNeeded() {
  if (CONFIG.USE_FIREBASE && CONFIG.FIREBASE_CONFIG && CONFIG.FIREBASE_CONFIG.apiKey) {
    appState.firebaseApp = firebase.initializeApp(CONFIG.FIREBASE_CONFIG);
    appState.auth = firebase.auth();
    appState.db = firebase.firestore();
  }
}

/** Real auth (Firebase) or demo auth (local) */
async function signUp(email, password) {
  if (appState.auth) {
    const res = await appState.auth.createUserWithEmailAndPassword(email, password);
    return { uid: res.user.uid, email: res.user.email };
  } else {
    const hash = await sha256(password);
    const uid = rid('uid');
    appState.demoUsers[email] = { hash, uid };
    localStorage.setItem('demoUsers', JSON.stringify(appState.demoUsers));
    return { uid, email };
  }
}
async function signIn(email, password) {
  if (appState.auth) {
    const res = await appState.auth.signInWithEmailAndPassword(email, password);
    return { uid: res.user.uid, email: res.user.email };
  } else {
    const users = JSON.parse(localStorage.getItem('demoUsers') || '{}');
    appState.demoUsers = users;
    const u = users[email];
    if (!u) throw new Error('User not found. Please sign up.');
    const hash = await sha256(password);
    if (hash !== u.hash) throw new Error('Invalid credentials.');
    return { uid: u.uid, email };
  }
}
async function signOut() {
  if (appState.auth) await appState.auth.signOut();
  appState.user = null;
}

/** Progress persistence (Firestore OR SQL OR local) */
async function saveProgress(uid, data) {
  if (CONFIG.USE_FIREBASE && appState.db) {
    await appState.db.collection('users').doc(uid).set({ email: appState.user.email }, { merge:true });
    await appState.db.collection('users').doc(uid).collection('progress').doc('main').set(data, { merge:true });
  } else if (CONFIG.USE_SQL_BACKEND && CONFIG.SQL_BACKEND_URL) {
    await fetch(`${CONFIG.SQL_BACKEND_URL}/api/progress/${uid}`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
    });
  } else {
    localStorage.setItem(`progress_${uid}`, JSON.stringify(data));
  }
}
async function loadProgress(uid) {
  if (CONFIG.USE_FIREBASE && appState.db) {
    const doc = await appState.db.collection('users').doc(uid).collection('progress').doc('main').get();
    return doc.exists ? doc.data() : null;
  } else if (CONFIG.USE_SQL_BACKEND && CONFIG.SQL_BACKEND_URL) {
    const res = await fetch(`${CONFIG.SQL_BACKEND_URL}/api/progress/${uid}`);
    if (res.ok) return await res.json();
    return null;
  } else {
    const raw = localStorage.getItem(`progress_${uid}`);
    return raw ? JSON.parse(raw) : null;
  }
}

/** ==================
 *  Short Answer Grading Engine (rule-based)
 *  ================== */
function gradeShortAnswer(answer, rubric) {
  const a = (answer||'').toLowerCase();
  let score = 0;
  const notes = [];
  for (const kw of rubric.keywords) {
    const hit = kw.group.some(g => a.includes(g.toLowerCase()));
    if (hit) { score += kw.weight; notes.push(`✓ Mentioned ${kw.group[0]}`); }
    else { notes.push(`• Consider including: ${kw.group.slice(0,2).join(' / ')}`); }
  }
  score = Math.min(1, Math.max(0, score));
  const ok = score >= (rubric.minScore ?? .7);
  const feedback = ok
    ? "Great! You hit the key ideas."
    : `Not quite. Model guidance:\n${rubric.modelAnswer}\n\nTips:\n- ${notes.join('\n- ')}`;
  return { score, ok, feedback };
}

/** ==================
 *  UI Components
 *  ================== */
function Badge({children, tone='brand'}) {
  const palette = {
    brand:'bg-brand/20 text-brand ring-1 ring-brand/40',
    green:'bg-green-500/20 text-green-300 ring-1 ring-green-500/40',
    red:'bg-red-500/20 text-red-300 ring-1 ring-red-500/40',
    gray:'bg-white/10 text-white/70 ring-1 ring-white/10'
  };
  return <span className={cx("px-2 py-1 rounded-full text-xs font-semibold", palette[tone])}>{children}</span>
}

function ToolChip({name, onClick}) {
  return (
    <button
      className="px-3 py-1 rounded-full bg-white/10 hover:bg-white/20 text-sm border border-white/10"
      onClick={onClick}
      aria-label={`Learn about ${name}`}
    >
      <i className="fa-solid fa-circle-info mr-2"></i>{name}
    </button>
  );
}

function ToolModal({tool, onClose}) {
  if (!tool) return null;
  const t = TOOL_DB[tool];
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/60" onClick={onClose} aria-label="Close"></div>
      <motion.div initial={{y:60,opacity:0}} animate={{y:0,opacity:1}} className="glass shadow-glass rounded-2xl p-6 w-full max-w-xl">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-xl font-semibold">{tool}</h3>
          <button onClick={onClose} className="text-white/70 hover:text-white"><i className="fa-solid fa-xmark"></i></button>
        </div>
        <p className="text-white/80 mb-4">{t.what}</p>
        <ol className="list-decimal list-inside space-y-2 mb-4">
          {t.steps.map((s, i)=> <li key={i}>{s}</li>)}
        </ol>
        <a className="inline-flex items-center gap-2 px-4 py-2 bg-brand text-black font-semibold rounded-lg" href={t.link} target="_blank" rel="noreferrer">
          <i className="fa-solid fa-up-right-from-square"></i> Open Official Site
        </a>
      </motion.div>
    </div>
  );
}

function Toast({text}) {
  return (
    <motion.div
      initial={{y:30,opacity:0}} animate={{y:0,opacity:1}} exit={{y:30,opacity:0}}
      className="px-4 py-2 rounded-lg bg-black/70 text-white/90"
    >
      {text}
    </motion.div>
  );
}

function FullscreenButton({targetRef}) {
  const goFull = async () => {
    const el = targetRef.current;
    if (!el) return;
    if (!document.fullscreenElement) {
      await el.requestFullscreen?.();
    } else {
      await document.exitFullscreen?.();
    }
  };
  return (
    <button onClick={goFull} className="px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20 border border-white/10 text-sm">
      <i className="fa-solid fa-maximize mr-2"></i>Toggle Fullscreen
    </button>
  );
}

/** Terminal sim (safe) */
function Terminal({script=[]}) {
  const [lines, setLines] = useState(["user@academy:~$"]);
  const [value, setValue] = useState("");
  const [i, setI] = useState(0);

  const runLine = (cmd) => {
    const out = [];
    const c = cmd.trim();
    if (!c) return;
    if (c.startsWith('nmap')) out.push("Starting Nmap 7.94 ...\n22/tcp open ssh\n80/tcp open http\n443/tcp open https");
    else if (c.startsWith('whoami')) out.push("analyst");
    else if (c.startsWith('netstat')) out.push("tcp 0 0 0.0.0.0:22 LISTEN\ntcp 0 0 0.0.0.0:80 LISTEN");
    else if (c==='help') out.push("Try: whoami, netstat -tuln, nmap -sS 127.0.0.1");
    else out.push("Command not recognized in simulation. Try 'help'.");
    setLines(prev => [...prev, `user@academy:~$ ${escapeHtml(cmd)}`, ...out]);
    setValue("");
  };

  const runScript = async () => {
    for (let j=i; j<script.length; j++) {
      setLines(prev => [...prev, `user@academy:~$ ${escapeHtml(script[j].cmd)}`, script[j].out]);
      setI(j+1);
      await wait(500);
    }
  };

  return (
    <div className="rounded-2xl overflow-hidden border border-white/10">
      <div className="bg-black/70 px-4 py-2 flex items-center justify-between">
        <div className="text-xs text-white/60">CyberSec Lab</div>
        <div className="space-x-2">
          <button onClick={()=>{ setLines(["user@academy:~$"]); setI(0); }} className="text-xs px-2 py-1 bg-white/10 rounded">Reset</button>
          <button onClick={runScript} className="text-xs px-2 py-1 bg-brand text-black rounded">Run Lesson Sequence</button>
        </div>
      </div>
      <div className="bg-black/60 p-4 min-h-[220px] font-mono text-sm whitespace-pre-wrap">
        {lines.join('\n')}
      </div>
      <div className="bg-black/70 p-2 flex gap-2">
        <input value={value} onChange={e=>setValue(e.target.value)} onKeyDown={e=> e.key==='Enter' && runLine(value)}
               className="flex-1 bg-black/40 border border-white/10 rounded px-3 py-2 outline-none"
               placeholder="Type a command (try: whoami, nmap -sS 127.0.0.1)"/>
        <button onClick={()=>runLine(value)} className="px-4 py-2 rounded bg-white/10 hover:bg-white/20">Run</button>
      </div>
    </div>
  );
}

/** Story block renderer */
function StoryBlock({block, onTool}) {
  if (block.type==='text') return <p className="text-white/85 leading-relaxed">{block.content}</p>;
  if (block.type==='info') return <div className="p-4 rounded-xl bg-white/5 border border-white/10">{block.content}</div>;
  if (block.type==='code') return (
    <div className="code-block border border-white/10">
      <pre><code className={block.lang}>{block.content}</code></pre>
    </div>
  );
  if (block.type==='chips') return (
    <div className="flex flex-wrap gap-2">
      {block.items.map(it => <ToolChip key={it} name={it} onClick={()=>onTool(it)} />)}
    </div>
  );
  return null;
}

/** Drag-match */
function DragMatch({pairs, onComplete}) {
  const [answers, setAnswers] = useState({});
  const left = pairs.map(([L])=>L);
  const right = useMemo(()=>pairs.map(([_,R])=>R).sort(()=>Math.random()-0.5), [pairs]);

  const isDone = left.every(l => answers[l]);

  return (
    <div>
      <div className="grid md:grid-cols-2 gap-4">
        <div className="space-y-2">
          {left.map(L=>(
            <div key={L} className="p-3 rounded-lg bg-white/5 border border-white/10">
              <div className="text-sm mb-2 font-semibold">{L}</div>
              <select className="w-full bg-black/40 border border-white/10 rounded px-2 py-2"
                defaultValue=""
                onChange={e=> setAnswers(prev=>({...prev, [L]: e.target.value}))}
              >
                <option value="" disabled>Match description…</option>
                {right.map(R=> <option key={R} value={R}>{R}</option>)}
              </select>
            </div>
          ))}
        </div>
        <div className="p-3 rounded-lg bg-white/5 border border-white/10">
          <div className="text-sm opacity-70 mb-2">Descriptions</div>
          <ul className="space-y-2 list-disc list-inside">
            {right.map(R => <li key={R}>{R}</li>)}
          </ul>
        </div>
      </div>
      <div className="mt-4 flex gap-2">
        <button
          className="px-4 py-2 rounded bg-brand text-black font-semibold disabled:opacity-50"
          disabled={!isDone}
          onClick={()=>{
            // check
            const ok = pairs.every(([L,R])=>answers[L]===R);
            if (ok) onComplete(true, "Excellent — all matches correct!");
            else onComplete(false, "Some matches are off. Re-check the definitions shown at right and try again.");
          }}
        >Check Answers</button>
        <button className="px-4 py-2 rounded bg-white/10" onClick={()=>setAnswers({})}>Reset</button>
      </div>
    </div>
  );
}

/** Multiple Choice with explanations + Try Again */
function MCQuestion({options, onResult}) {
  const [choice, setChoice] = useState(null);
  const [locked, setLocked] = useState(false);

  return (
    <div className="space-y-2">
      {options.map((o,i)=>(
        <button key={i}
          onClick={()=>!locked && setChoice(i)}
          className={cx(
            "w-full text-left px-4 py-3 rounded-lg border",
            choice===i ? "bg-white/15 border-white/20" : "bg-white/5 hover:bg-white/10 border-white/10"
          )}
        >
          {o.t}
        </button>
      ))}
      <div className="flex gap-2 pt-2">
        {!locked && <button className="px-4 py-2 bg-brand text-black rounded" onClick={()=>{
          if (choice==null) return;
          setLocked(true);
          const correct = options[choice].correct;
          onResult(correct, options[choice].why, options.find(x=>x.correct)?.t);
        }}>Submit</button>}
        {locked && <button className="px-4 py-2 bg-white/10 rounded" onClick={()=>{ setChoice(null); setLocked(false); }}>Try Again</button>}
      </div>
    </div>
  );
}

/** Short Answer with rubric grading + retry */
function ShortAnswer({rubric, onResult}) {
  const [val, setVal] = useState("");
  const [feedback, setFeedback] = useState(null);
  const [ok, setOk] = useState(false);

  return (
    <div className="space-y-2">
      <textarea rows={4} value={val} onChange={e=>setVal(e.target.value)}
        className="w-full bg-black/40 border border-white/10 rounded p-3" placeholder="Type your answer…"></textarea>
      <div className="flex gap-2">
        <button className="px-4 py-2 bg-brand text-black rounded"
          onClick={()=>{
            const res = gradeShortAnswer(val, rubric);
            setFeedback(res.feedback);
            setOk(res.ok);
            onResult(res.ok, res.feedback);
          }}
        >Check Answer</button>
        <button className="px-4 py-2 bg-white/10 rounded" onClick={()=>{ setVal(""); setFeedback(null); setOk(false); }}>Try Again</button>
      </div>
      {feedback && (
        <div className={cx("p-3 rounded-lg border", ok ? "bg-green-500/10 border-green-500/30" : "bg-red-500/10 border-red-500/30")}>
          <pre className="whitespace-pre-wrap">{feedback}</pre>
        </div>
      )}
    </div>
  );
}

/** Lesson Module: Story ➜ Practice ➜ Quiz */
function LessonModule({module, onClose, onProgress, user}) {
  const [tool, setTool] = useState(null);
  const [step, setStep] = useState(0);
  const [toast, setToast] = useState(null);
  const containerRef = useRef(null);

  const giveXP = async (pts=10) => {
    setToast(`+${pts} XP`);
    setTimeout(()=>setToast(null), 1500);
    await onProgress({ xpDelta: pts });
  };

  // Steps: 0 = story, 1 = practice, 2 = quiz
  const next = ()=> setStep(s => Math.min(2, s+1));
  const prev = ()=> setStep(s => Math.max(0, s-1));

  return (
    <div ref={containerRef} className="fixed inset-0 z-40 flex">
      <div className="relative flex-1 p-4 md:p-8 bg-brand-dark bg-grid dot">
        <div className="absolute inset-0 pointer-events-none bg-gradient-to-b from-white/5 to-transparent"></div>

        <div className="max-w-5xl mx-auto">
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-2xl md:text-3xl font-bold">{module.title}</h2>
            <div className="flex gap-2">
              <FullscreenButton targetRef={containerRef}/>
              <button onClick={onClose} className="px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20 border border-white/10 text-sm">
                <i className="fa-solid fa-xmark mr-2"></i>Exit
              </button>
            </div>
          </div>

          <div className="space-y-6 scroll-snap-y">
            {step===0 && (
              <motion.div initial={{opacity:0,y:20}} animate={{opacity:1,y:0}} className="snap-child">
                <Badge tone="gray">Story Mode</Badge>
                <div className="mt-3 grid gap-4">
                  {module.story.map((b, idx)=> <StoryBlock key={idx} block={b} onTool={setTool}/>)}
                </div>
                <div className="mt-6 flex gap-2">
                  <button onClick={next} className="px-4 py-2 rounded bg-brand text-black font-semibold">Begin Practice</button>
                </div>
              </motion.div>
            )}

            {step===1 && (
              <motion.div initial={{opacity:0,y:20}} animate={{opacity:1,y:0}} className="snap-child">
                <Badge tone="brand">Practice</Badge>
                <div className="mt-3 space-y-6">
                  {module.practice.map((p, i)=>(
                    <div key={i} className="p-4 rounded-xl bg-white/5 border border-white/10">
                      <div className="flex items-center justify-between mb-3">
                        <h4 className="font-semibold">{p.title}</h4>
                        <Badge tone="gray">{p.mode==='short' ? 'Short Answer' : p.mode==='mc' ? 'Multiple Choice' : 'Drag & Match'}</Badge>
                      </div>
                      {p.mode==='dragmatch' && <DragMatch pairs={p.pairs} onComplete={(ok,msg)=>{ alert(msg); if (ok) giveXP(10); }}/>}
                      {p.mode==='mc' && <MCQuestion options={p.options} onResult={(ok,why,correct)=>{
                        alert(ok ? `Correct! ${why}` : `Not quite.\n\nWhy:\n${why}\n\nCorrect answer:\n${correct}`);
                        if (ok) giveXP(10);
                      }}/>}
                      {p.mode==='short' && <ShortAnswer rubric={p.rubric} onResult={(ok,fb)=>{ if(ok) giveXP(12); }} />}
                    </div>
                  ))}
                </div>
                <div className="mt-6 flex gap-2">
                  <button onClick={prev} className="px-4 py-2 rounded bg-white/10">Back</button>
                  <button onClick={next} className="px-4 py-2 rounded bg-brand text-black font-semibold">Go to Quiz</button>
                </div>
              </motion.div>
            )}

            {step===2 && (
              <motion.div initial={{opacity:0,y:20}} animate={{opacity:1,y:0}} className="snap-child">
                <Badge tone="green">Final Quiz</Badge>
                <div className="mt-3 space-y-6">
                  {module.quiz.map((q, i)=>(
                    <div key={i} className="p-4 rounded-xl bg-white/5 border border-white/10">
                      <div className="font-semibold mb-3">{q.q}</div>
                      <MCQuestion options={q.answers} onResult={(ok,why,correct)=>{
                        alert(ok ? `Correct! ${why}` : `Not quite.\n\nWhy:\n${why}\n\nCorrect answer:\n${correct}\n\nTry again!`);
                        if (ok) giveXP(15);
                      }}/>
                    </div>
                  ))}
                </div>
                <div className="mt-6 flex gap-2">
                  <button onClick={prev} className="px-4 py-2 rounded bg-white/10">Back</button>
                  <button onClick={onClose} className="px-4 py-2 rounded bg-green-500 text-black font-semibold">Finish Module</button>
                </div>
              </motion.div>
            )}
          </div>
        </div>
      </div>

      <AnimatePresence>{tool && <ToolModal tool={tool} onClose={()=>setTool(null)} />}</AnimatePresence>
      <div className="fixed bottom-4 left-1/2 -translate-x-1/2 z-50">
        <AnimatePresence>{toast && <Toast text={toast} />}</AnimatePresence>
      </div>
    </div>
  );
}

/** Course Map (Red/Blue) */
function CourseMap({title, nodes=[], progress={}, onOpen}) {
  // simple grid layout
  return (
    <div className="p-4 rounded-2xl bg-white/5 border border-white/10">
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-xl font-semibold">{title}</h3>
        <Badge tone="gray">{Object.keys(progress).length} completed</Badge>
      </div>
      <div className="grid sm:grid-cols-2 md:grid-cols-3 gap-3">
        {nodes.map(n=>{
          const locked = n.prereq.some(p=>!progress[p]);
          const done = progress[n.id];
          return (
            <button key={n.id}
              disabled={locked}
              onClick={()=>onOpen(n)}
              className={cx(
                "text-left p-4 rounded-xl border transition",
                done ? "bg-green-500/10 border-green-500/30" : locked ? "bg-white/5 border-white/10 opacity-60 cursor-not-allowed" : "bg-white/5 border-white/10 hover:bg-white/10"
              )}
            >
              <div className="flex items-center justify-between">
                <span className="font-semibold">{n.title}</span>
                {done ? <i className="fa-solid fa-check text-green-400"></i> : locked ? <i className="fa-solid fa-lock"></i> : <i className="fa-solid fa-arrow-right"></i>}
              </div>
              <div className="mt-2 text-xs opacity-70">Prereq: {n.prereq.length ? n.prereq.join(', ') : 'None'}</div>
            </button>
          );
        })}
      </div>
    </div>
  );
}

/** Auth Modal */
function AuthModal({onClose, onAuthed}) {
  const [tab, setTab] = useState('login');
  const [email, setEmail] = useState('');
  const [pass, setPass] = useState('');
  const [err, setErr] = useState('');

  return (
    <div className="fixed inset-0 z-50 grid place-items-center p-4">
      <div className="absolute inset-0 bg-black/60" onClick={onClose}></div>
      <motion.div initial={{scale:.9,opacity:0}} animate={{scale:1,opacity:1}} className="glass rounded-2xl p-6 w-full max-w-md border border-white/10">
        <div className="flex items-center justify-between mb-4">
          <div className="flex gap-2">
            <button onClick={()=>setTab('login')} className={cx("px-3 py-1 rounded-lg", tab==='login' ? "bg-brand text-black" : "bg-white/10")}>Log In</button>
            <button onClick={()=>setTab('signup')} className={cx("px-3 py-1 rounded-lg", tab==='signup' ? "bg-brand text-black" : "bg-white/10")}>Sign Up</button>
          </div>
          <button onClick={onClose} className="text-white/70 hover:text-white"><i className="fa-solid fa-xmark"></i></button>
        </div>
        {err && <div className="mb-3 p-2 rounded bg-red-500/10 border border-red-500/30 text-sm">{err}</div>}
        <div className="space-y-3">
          <div>
            <label className="text-sm block opacity-80 mb-1">Email</label>
            <input value={email} onChange={e=>setEmail(e.target.value)} type="email" className="w-full bg-black/40 border border-white/10 rounded px-3 py-2"/>
          </div>
          <div>
            <label className="text-sm block opacity-80 mb-1">Password</label>
            <input value={pass} onChange={e=>setPass(e.target.value)} type="password" className="w-full bg-black/40 border border-white/10 rounded px-3 py-2"/>
          </div>
          <button className="w-full px-4 py-2 rounded bg-brand text-black font-semibold" onClick={async ()=>{
            try {
              const fn = tab==='login' ? signIn : signUp;
              const user = await fn(email, pass);
              appState.user = user;
              const existing = await loadProgress(user.uid);
              onAuthed(user, existing);
              onClose();
            } catch (e) { setErr(e.message); }
          }}>{tab==='login' ? 'Log In' : 'Create Account'}</button>
          {!CONFIG.USE_FIREBASE && (
            <div className="text-xs opacity-70 text-center">Demo auth is active (local only). Add Firebase config in CONFIG to enable real auth.</div>
          )}
        </div>
      </motion.div>
    </div>
  );
}

/** Root App */
function App() {
  const [page, setPage] = useState('home');
  const [showAuth, setShowAuth] = useState(false);
  const [user, setUser] = useState(null);
  const [progress, setProgress] = useState({ xp:0, fundamentals:{}, red:{}, blue:{} });

  useEffect(()=>{ initFirebaseIfNeeded(); }, []);

  // persist on change
  useEffect(()=>{
    if (user) saveProgress(user.uid, progress);
  }, [progress?.xp, progress?.fundamentals, progress?.red, progress?.blue]);

  const openModule = (m) => {
    const onClose = async ()=>{
      setPage('learn'); // return to learning page
      // mark completion if not already
      setProgress(p => ({ ...p, fundamentals: { ...p.fundamentals, [m.id]: true } }));
    };
    const onProgress = async ({ xpDelta=0 }) => setProgress(p => ({...p, xp: (p.xp||0) + xpDelta }));
    const node = document.createElement('div');
    document.body.appendChild(node);
    ReactDOM.render(<LessonModule module={m} onClose={onClose} onProgress={onProgress} user={user} />, node);
  };

  const openNode = (n, type) => {
    alert(`${n.title}\n\nThis opens a themed module in ${type.toUpperCase()} path.\n(You can connect this to detailed content exactly like FUNDAMENTALS.)`);
    setProgress(p => ({ ...p, [type]: { ...p[type], [n.id]: true } }));
  };

  const xpPct = Math.min(100, Math.round(((Object.keys(progress.fundamentals).length + Object.keys(progress.red).length + Object.keys(progress.blue).length) / 20) * 100));

  return (
    <div className="min-h-screen flex flex-col">
      {/* Header */}
      <header className="sticky top-0 z-30">
        <div className="glass border-b border-white/10">
          <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="relative">
                <div className="absolute inset-0 rounded-full animate-[pulse-ring_1.8s_ease-out_infinite]"></div>
                <div className="h-10 w-10 rounded-full bg-brand"></div>
              </div>
              <div className="text-lg font-bold">CyberSec Academy</div>
              <Badge>Immersive Story-Driven Learning</Badge>
            </div>
            <nav className="hidden md:flex items-center gap-2">
              {['home','learn','redblue','labs','dashboard'].map(p => (
                <button key={p} onClick={()=>setPage(p)}
                  className={cx("px-3 py-2 rounded-lg text-sm", page===p ? "bg-white/15" : "hover:bg-white/10")}>
                  {p==='redblue' ? 'Red & Blue' : p[0].toUpperCase()+p.slice(1)}
                </button>
              ))}
            </nav>
            <div className="flex items-center gap-2">
              {user ? (
                <>
                  <Badge tone="green">{user.email}</Badge>
                  <button className="px-3 py-2 bg-white/10 rounded" onClick={async()=>{
                    await signOut(); setUser(null);
                  }}>Sign out</button>
                </>
              ) : (
                <button className="px-3 py-2 bg-brand text-black rounded font-semibold" onClick={()=>setShowAuth(true)}>Log in / Sign up</button>
              )}
            </div>
          </div>
        </div>
        {/* progress bar */}
        <div className="h-1 bg-white/10">
          <div className="h-1 bg-brand" style={{width: `${xpPct}%`}}></div>
        </div>
      </header>

      {/* Pages */}
      <main className="flex-1">
        {page==='home' && (
          <section className="relative overflow-hidden">
            <div className="absolute inset-0 dot opacity-50"></div>
            <div className="max-w-7xl mx-auto px-4 py-16 relative">
              <div className="grid md:grid-cols-2 gap-10 items-center">
                <motion.div initial={{opacity:0,y:20}} animate={{opacity:1,y:0}}>
                  <h1 className="text-4xl md:text-5xl font-black leading-tight">Master Cybersecurity with <span className="text-brand">Story-Driven Labs</span></h1>
                  <p className="mt-4 text-white/80 text-lg">Learn by doing: immersive scenarios, interactive terminals, guided explanations, and auto-graded short answers.</p>
                  <div className="mt-6 flex gap-3">
                    <button onClick={()=>setPage('learn')} className="px-5 py-3 bg-brand text-black rounded-xl font-bold">Start Learning</button>
                    <button onClick={()=>setPage('redblue')} className="px-5 py-3 bg-white/10 rounded-xl">Explore Red & Blue Paths</button>
                  </div>
                </motion.div>
                <motion.div initial={{opacity:0,scale:.95}} animate={{opacity:1,scale:1}} transition={{delay:.1}}>
                  <Terminal script={[
                    {cmd:'whoami', out:'analyst'},
                    {cmd:'nmap -sS 192.168.1.0/24', out:'22/tcp open ssh\n80/tcp open http\n443/tcp open https'}
                  ]}/>
                </motion.div>
              </div>
            </div>
          </section>
        )}

        {page==='learn' && (
          <section className="max-w-7xl mx-auto px-4 py-10 space-y-6">
            <div className="flex items-center justify-between">
              <h2 className="text-2xl font-bold">Fundamentals Path</h2>
              <div className="text-sm opacity-70">{Object.keys(progress.fundamentals).length} / {FUNDAMENTALS.length} completed</div>
            </div>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
              {FUNDAMENTALS.map(m => {
                const done = !!progress.fundamentals[m.id];
                return (
                  <motion.div key={m.id} whileHover={{y:-2}} className={cx("p-4 rounded-2xl border", done ? "bg-green-500/10 border-green-500/30" : "bg-white/5 border-white/10")}>
                    <div className="flex items-start justify-between gap-3">
                      <div>
                        <h3 className="font-semibold">{m.title}</h3>
                        <div className="mt-1 text-sm opacity-70">{done ? 'Completed' : 'Story → Practice → Quiz'}</div>
                      </div>
                      {done ? <i className="fa-solid fa-check text-green-400"></i> : <i className="fa-solid fa-book-open text-brand"></i>}
                    </div>
                    <div className="mt-4 flex gap-2">
                      {!done && <button className="px-3 py-2 bg-brand text-black rounded-lg font-semibold" onClick={()=>openModule(m)}>Start</button>}
                      {done && <button className="px-3 py-2 bg-white/10 rounded-lg" onClick={()=>openModule(m)}>Review</button>}
                    </div>
                  </motion.div>
                );
              })}
            </div>
          </section>
        )}

        {page==='redblue' && (
          <section className="max-w-7xl mx-auto px-4 py-10 space-y-6">
            <h2 className="text-2xl font-bold mb-2">Red & Blue Teams</h2>
            <p className="opacity-80">Choose your path. Each node unlocks after you complete its prerequisites. Content uses the same immersive module format.</p>
            <div className="grid lg:grid-cols-2 gap-6 mt-6">
              <CourseMap title="Red Team Path" nodes={RED_COURSE} progress={progress.red} onOpen={(n)=>openNode(n,'red')} />
              <CourseMap title="Blue Team Path" nodes={BLUE_COURSE} progress={progress.blue} onOpen={(n)=>openNode(n,'blue')} />
            </div>
          </section>
        )}

        {page==='labs' && (
          <section className="max-w-5xl mx-auto px-4 py-10 space-y-6">
            <h2 className="text-2xl font-bold">Interactive Labs</h2>
            <p className="opacity-80">Sandboxed command simulations with guided sequences.</p>
            <Terminal script={[
              {cmd:'whoami', out:'analyst'},
              {cmd:'netstat -tuln', out:'tcp 0 0 0.0.0.0:22 LISTEN\ntcp 0 0 0.0.0.0:80 LISTEN'},
              {cmd:'nmap -sV -O 127.0.0.1', out:'22/tcp open ssh OpenSSH 8.9\nOS details: Linux 5.x'}
            ]}/>
          </section>
        )}

        {page==='dashboard' && (
          <section className="max-w-7xl mx-auto px-4 py-10 space-y-6">
            <h2 className="text-2xl font-bold">Your Dashboard</h2>
            <div className="grid md:grid-cols-3 gap-6">
              <div className="p-4 rounded-2xl bg-white/5 border border-white/10">
                <div className="text-sm opacity-70">Total XP</div>
                <div className="text-4xl font-black mt-2">{progress.xp||0}</div>
              </div>
              <div className="p-4 rounded-2xl bg-white/5 border border-white/10">
                <div className="text-sm opacity-70">Fundamentals Completed</div>
                <div className="text-4xl font-black mt-2">{Object.keys(progress.fundamentals).length}/{FUNDAMENTALS.length}</div>
              </div>
              <div className="p-4 rounded-2xl bg-white/5 border border-white/10">
                <div className="text-sm opacity-70">Red/Blue Nodes</div>
                <div className="text-4xl font-black mt-2">{Object.keys(progress.red).length + Object.keys(progress.blue).length}/10</div>
              </div>
            </div>
            <div className="p-4 rounded-2xl bg-white/5 border border-white/10">
              <h3 className="font-semibold mb-2">Next Recommendations</h3>
              <ul className="list-disc list-inside opacity-90">
                <li>Finish Fundamentals Module 1 (if not complete)</li>
                <li>Open Red: Recon & OSINT</li>
                <li>Blue: Log Fundamentals → try a short ELK stack lab</li>
              </ul>
            </div>
          </section>
        )}
      </main>

      <footer className="mt-12 border-t border-white/10">
        <div className="max-w-7xl mx-auto px-4 py-10 grid md:grid-cols-3 gap-6">
          <div>
            <div className="font-bold text-lg">CyberSec Academy</div>
            <p className="text-white/70 mt-2">Hands-on cybersecurity learning that teaches before testing.</p>
          </div>
          <div>
            <div className="font-semibold">Tools</div>
            <div className="mt-3 flex flex-wrap gap-2">
              {Object.keys(TOOL_DB).map(k => <ToolChip key={k} name={k} onClick={()=>alert('Open any module to see full tool explainers with steps and links.')} />)}
            </div>
          </div>
          <div>
            <div className="font-semibold">Get Started</div>
            <div className="mt-3 flex gap-2">
              <button className="px-3 py-2 bg-brand text-black rounded" onClick={()=>document.querySelector('header nav button:nth-child(2)')?.click()}>Start Fundamentals</button>
              <button className="px-3 py-2 bg-white/10 rounded" onClick={()=>document.querySelector('header nav button:nth-child(3)')?.click()}>Explore Red & Blue</button>
            </div>
          </div>
        </div>
      </footer>

      <AnimatePresence>{showAuth && <AuthModal onClose={()=>setShowAuth(false)} onAuthed={(u, existing)=>{ setUser(u); if (existing) setProgress(existing); }}/>}</AnimatePresence>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
